@using Service
@using Service.Interfaces
@using Domain.Models

<MudDialog>
    <TitleContent>
        <MudStack AlignItems="AlignItems.Center" Row>
            <MudIcon Size="Size.Small" Color="Color.Primary" Icon="@Icons.Material.Filled.EditNote"></MudIcon>
            <MudText Typo="Typo.caption">Change Password</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudGrid Spacing="1">
            <MudItem Class="mb-4" xs="12">
                <MudTextField @bind-Value="_current" T="string" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Dense" Label="Current Password" ShrinkLabel Password="true"></MudTextField>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_new" T="string" InputType="InputType.Password"  Variant="Variant.Outlined" Margin="Margin.Dense" Label="New Password" ShrinkLabel Password="true"></MudTextField>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_confirm" T="string" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Dense" Label="Confirm password" ShrinkLabel Password="true"></MudTextField>
            </MudItem>
            @if (!string.IsNullOrEmpty(_error))
            {
                <MudItem xs="12">
                    <MudText Color="Color.Error">@_error</MudText>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudStack Justify="Justify.FlexEnd" Row>
            <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="Cancel" Disabled="@_isBusy">Cancel</MudButton>
            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" OnClick="ChangeAsync" Disabled="@_isBusy">Change</MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;

    [Inject] public IUserService UserService { get; set; } = null!;
    [Inject] public MudBlazor.ISnackbar Snackbar { get; set; } = null!;
    [Inject] public AppStateService AppStateService { get; set; } = null!;

    private string _current = string.Empty;
    private string _new = string.Empty;
    private string _confirm = string.Empty;
    private string? _error;
    private bool _isBusy;

    private void Cancel()
    {
        MudDialog.Close();
    }

    private async Task ChangeAsync()
    {
        _error = null;

        if (string.IsNullOrWhiteSpace(_current))
        {
            _error = "Current password is required.";
            Snackbar.Add(_error, MudBlazor.Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_new) || string.IsNullOrWhiteSpace(_confirm))
        {
            _error = "New password and confirmation are required.";
            Snackbar.Add(_error, MudBlazor.Severity.Error);
            return;
        }

        if (_new != _confirm)
        {
            _error = "New password and confirmation do not match.";
            Snackbar.Add(_error, MudBlazor.Severity.Error);
            return;
        }

        if (_new.Length < 6)
        {
            _error = "New password must be at least 6 characters.";
            Snackbar.Add(_error, MudBlazor.Severity.Warning);
            return;
        }

        _isBusy = true;

        var model = new ChangePasswordModel
        {
            UserId = AppStateService.CurrentUser?.Id ?? string.Empty,
            CurrentPassword = _current,
            NewPassword = _new
        };

        try
        {
            var result = await UserService.ChangePassword(model).ConfigureAwait(true);

            if (result.IsSuccess)
            {
                Snackbar.Add("Password changed successfully.", MudBlazor.Severity.Success);
                MudDialog.Close();
            }
            else
            {
                Snackbar.Add("There was a problem changing your password.", MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            // Snackbar.Add(_error, MudBlazor.Severity.Error);
        }
        finally
        {
            _isBusy = false;
            StateHasChanged();
        }
    }
}